{"version":3,"file":"legend-4a6e15bb.js","sources":["../../components/legend/legend.js"],"sourcesContent":["import './legend.css';\n\nimport Alpine from 'alpinejs';\nimport ImageWMS from 'ol/source/ImageWMS.js';\nimport VectorSource from 'ol/source/Vector.js';\nimport feather from 'feather-icons';\nimport { featureLayersGroup } from '../core/mapSetup/mapSetup.js';\nimport {renderMarkupAndSetPluginReady} from '../core/helper.js'\n\nconst createMarkupButton = () => {\n    const buttonHtml = `\n      <div x-data=\"{ get legend() { return $store.legend; } }\" class=\"mx-1\" :class=\"'order-'+legend.buttonDomOrder\" id=\"legendNavButton\">\n        <button type=\"button\" \n          class=\"btn btn-danger btn-sm btn-circle\" \n          x-tooltip.placement.left=\"'Legend'\"\n          @click=\"legend.toggleLegend($el)\"\n          :class=\"legend.componentIsActive ? 'bg-danger' : 'btn-light'\">\n          <i data-feather=\"info\" class=\"size-16\"></i>\n          </button>\n      </div>\n    `;\n  \n    // insert the plugin markup where we need it\n    document.getElementById('rightMiddleSlot').insertAdjacentHTML('beforeend', buttonHtml);\n\n  };\n\nconst createMarkupContainer = () => {\n\n    const slideOut = `\n          <div x-data=\"{ get legend() { return $store.legend; } }\" id=\"legendContainer\">\n          <div x-show=\"legend.showLegend\">\n              <div class=\"accordion\" id=\"legendAccordion\">\n                  <template x-for=\"item in legend.visibleLayers\" :key=\"item.get('name')\">\n                      <div class=\"accordion-item\">\n                          <p class=\"accordion-header py-0\">\n                              <button class=\"accordion-button py-1 btn-light btn-sm\" type=\"button\" @click=\"legend.toggleDetails(item)\">\n                                  <span x-text=\"item.get('name')\"></span>\n                              </button>\n                          </p>\n                          <div class=\"accordion-collapse collapse\" :class=\"{'show': item.showDetails}\">\n                              <div class=\"accordion-body\">\n                                  <img :src=\"legend.getLegendUrl(item)\" alt=\"\" x-show=\"item.get('type') === 'WMS' || item.get('type') === 'geonode'\">\n                                  <span x-show=\"item.get('type') !== 'WMS' && item.get('type') !== 'geonode'\">This layer does not support dynamic legend creation.</span>\n                              </div>\n                          </div>\n                      </div>\n                  </template>\n              </div>\n          </div>\n      </div>\n    `;\n  \n    // Replace the content of rightBottomSlot\n    document.getElementById('rightBottomSlot').innerHTML = slideOut;\n  };\n  \n\nconst initialize = (buttonDomOrder) => {\n\n  Alpine.store('legend', {\n    componentIsActive: false,\n    buttonDomOrder: buttonDomOrder,\n    showLegend: false,\n    visibleLayers: featureLayersGroup.getLayers().getArray().filter(layer => layer.getVisible()),\n\n    toggleLegend() {\n      this.componentIsActive = !this.componentIsActive;\n      this.showLegend = !this.showLegend;\n      this.updateVisibleLayers();\n    },\n\n    updateVisibleLayers() {\n      this.visibleLayers = featureLayersGroup.getLayers().getArray().filter(layer => layer.getVisible());\n      if (this.visibleLayers.length == 1){\n        const firstLayer = this.visibleLayers[0]\n       this.toggleDetails(firstLayer);\n      }\n    },\n\n    getLegendUrl(layer) {\n      const source = layer.getSource();\n      let baseUrl = typeof source.getUrl === 'function' ? source.getUrl() : source.getUrl;\n      const rootUrlRegex = /(https?:\\/\\/[^/]+\\/[^/]+)\\//;\n      const match = baseUrl.match(rootUrlRegex);\n      const basePart = match ? match[1] : baseUrl;\n\n      if (layer.getSource() instanceof ImageWMS) {\n        return `${basePart}/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=${source.getParams()['LAYERS']}`;\n      } else if (source instanceof VectorSource) {\n        return `${basePart}/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=${layer.get('layername')}`;\n      } else {\n        return '';\n      }\n    },\n    toggleDetails(item) {\n      console.log(item)\n      item.showDetails = !item.showDetails; // Toggle the visibility of the item\n    }\n  });\n\n\n  const domElementsToCreate = [ \n    [createMarkupButton, '#legendNavButton'],\n    [createMarkupContainer, '#legendContainer']\n  ]\n  renderMarkupAndSetPluginReady(domElementsToCreate)\n\n\n  // Catch the custom event and execute a function to update the legend\n  document.addEventListener('mapLayerHaveChanged', function (event) {\n    console.debug('Custom event \"mapLayerHaveChanged\" caught. Updating legend Markup');\n    Alpine.store('legend').updateVisibleLayers();\n  });\n\n\n};\n\nexport { initialize };\n"],"names":["createMarkupButton","buttonHtml","createMarkupContainer","slideOut","initialize","buttonDomOrder","Alpine","featureLayersGroup","layer","firstLayer","source","baseUrl","rootUrlRegex","match","basePart","ImageWMS","VectorSource","item","renderMarkupAndSetPluginReady","event"],"mappings":"kGASA,MAAMA,EAAqB,IAAM,CAC7B,MAAMC,EAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAanB,SAAS,eAAe,iBAAiB,EAAE,mBAAmB,YAAaA,CAAU,CAEzF,EAEMC,EAAwB,IAAM,CAEhC,MAAMC,EAAW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAyBjB,SAAS,eAAe,iBAAiB,EAAE,UAAYA,CAC3D,EAGMC,EAAcC,GAAmB,CAErCC,EAAO,MAAM,SAAU,CACrB,kBAAmB,GACnB,eAAgBD,EAChB,WAAY,GACZ,cAAeE,EAAmB,UAAS,EAAG,SAAQ,EAAG,OAAOC,GAASA,EAAM,YAAY,EAE3F,cAAe,CACb,KAAK,kBAAoB,CAAC,KAAK,kBAC/B,KAAK,WAAa,CAAC,KAAK,WACxB,KAAK,oBAAmB,CACzB,EAED,qBAAsB,CAEpB,GADA,KAAK,cAAgBD,EAAmB,YAAY,WAAW,OAAOC,GAASA,EAAM,WAAY,CAAA,EAC7F,KAAK,cAAc,QAAU,EAAE,CACjC,MAAMC,EAAa,KAAK,cAAc,CAAC,EACxC,KAAK,cAAcA,CAAU,CAC7B,CACF,EAED,aAAaD,EAAO,CAClB,MAAME,EAASF,EAAM,YACrB,IAAIG,EAAU,OAAOD,EAAO,QAAW,WAAaA,EAAO,OAAM,EAAKA,EAAO,OAC7E,MAAME,EAAe,8BACfC,EAAQF,EAAQ,MAAMC,CAAY,EAClCE,EAAWD,EAAQA,EAAM,CAAC,EAAIF,EAEpC,OAAIH,EAAM,UAAW,YAAYO,EACxB,GAAGD,CAAQ,yFAAyFJ,EAAO,YAAY,MAAS,GAC9HA,aAAkBM,EACpB,GAAGF,CAAQ,yFAAyFN,EAAM,IAAI,WAAW,CAAC,GAE1H,EAEV,EACD,cAAcS,EAAM,CAClB,QAAQ,IAAIA,CAAI,EAChBA,EAAK,YAAc,CAACA,EAAK,WAC1B,CACL,CAAG,EAODC,EAJ4B,CAC1B,CAAClB,EAAoB,kBAAkB,EACvC,CAACE,EAAuB,kBAAkB,CAC3C,CACgD,EAIjD,SAAS,iBAAiB,sBAAuB,SAAUiB,EAAO,CAChE,QAAQ,MAAM,mEAAmE,EACjFb,EAAO,MAAM,QAAQ,EAAE,oBAAmB,CAC9C,CAAG,CAGH"}